@page "/settingsPage"
@using ESOCompanion.Data
@inject AppData app
@using DataAccessLibrary.Models
@using DataAccessLibrary.Utilities
@using DataAccessLibrary.Services.MariaDb
@*@using System.IO.FileSystemInfo*@
@inject IMySqlDataAccess companionDB
@inject IUserData userData
@inject ICharacterData characterData
@inject IStyleData styleData

@inject NavigationManager NavManager

<h1 class="text-center"><img class="float-left" src="img/icon.png" width="64" height="64">Settings</h1>

<div class="container col-10">
    <div class="form-group">

        @*<form>
                <label class="form-label" for="toggleTheme">Toggle Theme:</label>
                <input type="checkbox" class="form-control-file" id="toggleTheme">

                <label class="form-label" for="databaseFile">Select Database File</label>
                <input type="file" class="form-control-file" id="databaseFile" @bind-value="path">

                <label class="form-label" for="addonsFolder">Select AddOns Folder</label>
                <input type="file" class="form-control-file" id="addonsFolder">

                <AuthorizeView>
                    <Authorized>
                        @if (AppData.Role == "Admin")
                        {
                            <div class="container align-self-auto" style="padding-bottom:4em">
                                <button class="btn btn-danger" style="padding:2px" @onclick="CleanDatabase">Clean Database</button>
                            </div>

                            <div class="container align-self-auto" style="padding-bottom:4em">
                                <button class="btn btn-danger" style="padding:2px" @onclick="CleanUserTable">Purge Users</button>
                            </div>
                        }
                        else if (AppData.Role == null)
                        {
                            <div class="container align-self-auto" style="padding-bottom:4em">
                                <button class="btn btn-danger" style="padding:2px" @onclick="CreateNewDatabase">Create New Database</button>
                            </div>
                        }
                    </Authorized>
                    <NotAuthorized>

                    </NotAuthorized>
                </AuthorizeView>
            </form>*@
        <EditForm Model="@dataFileModel" OnValidSubmit="@UserDatabaseSelect">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div>
                <label class="form-label" for="databaseFile">Select Database File</label>
                <InputFile id="filePath" />
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="path">Database Directory </span>
                </div>
                <InputText id="path" @bind-Value="dataFileModel.Path" />
            </div>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <span class="input-group-text" id="fileName">Name of Database </span>
                </div>
                <InputText id="fileName" @bind-Value="dataFileModel.FileName" />
            </div>
            <div class="container align-self-auto" style="padding-bottom:4em">
                <button class="btn btn-danger" style="padding:2px" @onclick="UserDatabaseSelect">Create New Database </button>
            </div>
            <div class="container align-self-auto" style="padding-bottom:4em">
                <button class="btn btn-danger" style="padding:2px" @onclick="CleanDatabase">Clean Database </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    static string filePath;
    static string path;
    static string fileName;
    DataFileModel dataFileModel = new DataFileModel(path, fileName);
    public void onAddonsFolderSelect(string addonsPath)
    {

    }

    private void UserDatabaseSelect()
    {
        onDatabaseFileSelect();
        //companionDB.CreateDatabaseAndTable(companionDB.UserConnectionString + filePath + AppData.defaultDatabasePathSuffix, true);

    }
    private void onDatabaseFileSelect()
    {
        path = dataFileModel.Path;
        fileName = dataFileModel.FileName;
        filePath = path + fileName;
        app.DataFile = dataFileModel;
    }

    private void CleanDatabase()
    {
        CleanUserTable();
        CleanCharacterTable();
        CleanStylesTable();
        NavManager.NavigateTo("/");
    }
    public void CleanUserTable()
    {
        //userData.ClearTable();
        userData.CreateUsersTable();
        userData.CreateDefaultUser();
        NavManager.NavigateTo("/");
    }
    public void CleanCharacterTable()
    {
        //characterData.ClearTable();
        characterData.CreateCharactersTable();
        characterData.CreateDefaultCharacter();
        NavManager.NavigateTo("/charactersListPage");
    }
    public void CleanStylesTable()
    {
        //styleData.ClearTable();
        styleData.CreateStylesTable();
        NavManager.NavigateTo("/stylesListPage");
    }
}